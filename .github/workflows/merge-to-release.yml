name: ðŸš€ Automatic Release Merge (main <-> release)

# This workflow can only be triggered manually from the GitHub Actions UI.
# This workflow was created with Gemini's help.
on:
  workflow_dispatch:

jobs:
  create_and_merge_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for peter-evans/create-pull-request to commit
      pull-requests: write # Needed to create and merge the PR

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # =================================================================
      # PHASE 1: MERGE RELEASE INTO MAIN (Overriding Protection)
      # This ensures any hotfixes in 'release' are synced back to 'main'.
      # =================================================================

      # 1. Create Pull Request (release -> main)
      - name: 1. Create PR (release -> main)
        id: cpr_up
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ci: merge release to main'
          title: 'ci: merge release to main'
          body: |
            Automatically generated by workflow to synchronize `release` into protected `main`.
          base: main    # The protected branch receiving the changes
          head: release # The branch providing the changes
          branch: release-to-main-sync
          # Will only create if there are changes.

      # 2. Extract PR Number (release -> main)
      - name: 2. Extract PR Number (release -> main)
        if: steps.cpr_up.outputs.pull-request-number
        id: pr_info_up
        run: echo "PR_NUM_UP=${{ steps.cpr_up.outputs.pull-request-number }}" >> $GITHUB_OUTPUT

      # 3. Merge Pull Request (release -> main)
      - name: 3. Merge PR (release -> main) (Bypass Protection)
        if: steps.cpr_up.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER_UP: ${{ steps.pr_info_up.outputs.PR_NUM_UP }}
        run: |
          echo "Attempting to merge PR #${PR_NUMBER_UP} into protected 'main'."
          COMMIT_TITLE="ci: merge release to main (#${PR_NUMBER_UP})"

          # Use --admin to bypass branch protection
          gh pr merge "$PR_NUMBER_UP" \
            --merge \
            --admin \
            --commit-title "$COMMIT_TITLE"

          echo "Successfully merged PR #${PR_NUMBER_UP} into main."

      - name: Log if No Changes Found (release -> main)
        if: ${{ steps.cpr_up.outputs.pull-request-number == '' }}
        run: echo "No changes detected between 'release' and 'main'. Phase 1 skipped."

      # =================================================================
      # PHASE 2: MERGE MAIN INTO RELEASE (The original request)
      # This ensures 'release' is always up-to-date with 'main'.
      # =================================================================

      # 4. Create Pull Request (main -> release)
      - name: 4. Create PR (main -> release)
        id: cpr_down
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ci: merge main to release'
          title: 'ci: merge main to relase'
          body: |
            This Pull Request was automatically generated by the GitHub Action workflow to synchronize `main` with the `release` branch.
          base: release # The branch receiving the changes
          head: main    # The branch providing the changes
          branch: main-to-release-sync
          # The action will only create the PR if there are changes between the branches.

      # 5. Get the PR number (only runs if the PR was actually created)
      - name: 5. Extract PR Number (main -> release)
        if: steps.cpr_down.outputs.pull-request-number
        id: pr_info_down
        run: echo "PR_NUM_DOWN=${{ steps.cpr_down.outputs.pull-request-number }}" >> $GITHUB_OUTPUT

      # 6. Merge the created Pull Request
      - name: 6. Merge PR (main -> release)
        # Only attempt to merge if a PR number was extracted in the previous step
        if: steps.cpr_down.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER_DOWN: ${{ steps.pr_info_down.outputs.PR_NUM_DOWN }}
        run: |
          echo "Attempting to merge PR #${PR_NUMBER_DOWN} into 'release'."

          # Construct the custom commit title: "ci: merge main to release (#nnnn)"
          COMMIT_TITLE="ci: merge main to release (#${PR_NUMBER_DOWN})"
          echo "Using custom merge commit title: ${COMMIT_TITLE}"

          # Merge the PR using GitHub CLI (gh) with the --merge option enforced.
          gh pr merge "$PR_NUMBER_DOWN" \
            --merge \
            --admin \
            --commit-title "$COMMIT_TITLE"

          echo "Successfully merged PR #${PR_NUMBER_DOWN}."

      - name: Log if No Changes Found (main -> release)
        # Log a success message if no PR was created (meaning branches were already in sync)
        if: ${{ steps.cpr_down.outputs.pull-request-number == '' }}
        run: echo "No changes detected between 'main' and 'release'. Phase 2 skipped."
